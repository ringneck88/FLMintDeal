---
import Layout from '../../../layouts/Layout.astro';

// Define all our data structures
const categories = [
  { name: 'Flower', slug: 'flower', icon: 'üåø' },
  { name: 'Edibles', slug: 'edibles', icon: 'üç≠' },
  { name: 'Concentrates', slug: 'concentrates', icon: 'üçØ' },
  { name: 'Vaporizers', slug: 'vaporizers', icon: 'üí®' },
  { name: 'Pre-Rolls', slug: 'pre-rolls', icon: 'üö¨' },
  { name: 'Topicals', slug: 'topicals', icon: 'üß¥' },
  { name: 'Cartridges', slug: 'cartridges', icon: 'üñäÔ∏è' }
];

const states = [
  { name: 'Florida', slug: 'florida', emoji: 'üå¥' },
  { name: 'California', slug: 'california', emoji: '‚òÄÔ∏è' },
  { name: 'Colorado', slug: 'colorado', emoji: 'üèîÔ∏è' },
  { name: 'Nevada', slug: 'nevada', emoji: 'üé∞' },
  { name: 'Arizona', slug: 'arizona', emoji: 'üåµ' },
  { name: 'New York', slug: 'new-york', emoji: 'üóΩ' },
  { name: 'Massachusetts', slug: 'massachusetts', emoji: 'ü¶û' },
  { name: 'Michigan', slug: 'michigan', emoji: 'üè≠' },
  { name: 'Illinois', slug: 'illinois', emoji: 'üåÜ' },
  { name: 'Oregon', slug: 'oregon', emoji: 'üå≤' },
  { name: 'Washington', slug: 'washington', emoji: '‚õ∞Ô∏è' }
];

// Define regions by state
const regions = {
  'florida': [
    { name: 'Miami-Dade', slug: 'miami-dade', type: 'Metro Area', population: '2.7M' },
    { name: 'Orlando', slug: 'orlando', type: 'City', population: '280K' },
    { name: 'Tampa Bay', slug: 'tampa-bay', type: 'Metro Area', population: '3.2M' },
    { name: 'Jacksonville', slug: 'jacksonville', type: 'City', population: '950K' },
    { name: 'South Beach', slug: 'south-beach', type: 'Neighborhood', population: '40K' }
  ],
  'california': [
    { name: 'Los Angeles', slug: 'los-angeles', type: 'City', population: '4M' },
    { name: 'San Francisco Bay Area', slug: 'bay-area', type: 'Metro Area', population: '7.7M' },
    { name: 'San Diego', slug: 'san-diego', type: 'City', population: '1.4M' },
    { name: 'Orange County', slug: 'orange-county', type: 'County', population: '3.2M' },
    { name: 'Silicon Valley', slug: 'silicon-valley', type: 'Region', population: '3M' },
    { name: 'Hollywood', slug: 'hollywood', type: 'Neighborhood', population: '85K' }
  ],
  'arizona': [
    { name: 'Phoenix', slug: 'phoenix', type: 'City', population: '1.7M' },
    { name: 'The Valley', slug: 'the-valley', type: 'Metro Area', population: '5M' },
    { name: 'Scottsdale', slug: 'scottsdale', type: 'City', population: '260K' },
    { name: 'Chandler', slug: 'chandler', type: 'City', population: '280K' },
    { name: 'Buckeye', slug: 'buckeye', type: 'City', population: '91K' },
    { name: 'Glendale', slug: 'glendale', type: 'City', population: '250K' },
    { name: 'Arcadia', slug: 'arcadia', type: 'Neighborhood', population: '60K' }
  ],
  'colorado': [
    { name: 'Denver', slug: 'denver', type: 'City', population: '715K' },
    { name: 'Denver Metro', slug: 'denver-metro', type: 'Metro Area', population: '2.9M' },
    { name: 'Boulder', slug: 'boulder', type: 'City', population: '108K' },
    { name: 'Colorado Springs', slug: 'colorado-springs', type: 'City', population: '480K' },
    { name: 'Fort Collins', slug: 'fort-collins', type: 'City', population: '170K' }
  ],
  'nevada': [
    { name: 'Las Vegas', slug: 'las-vegas', type: 'City', population: '650K' },
    { name: 'Las Vegas Strip', slug: 'las-vegas-strip', type: 'District', population: '50K' },
    { name: 'Reno', slug: 'reno', type: 'City', population: '264K' },
    { name: 'Henderson', slug: 'henderson', type: 'City', population: '320K' }
  ]
};

// Generate static paths for all category-state-region combinations
export async function getStaticPaths() {
  const paths = [];

  categories.forEach(category => {
    states.forEach(state => {
      const stateSlug = `${category.slug}-in-${state.slug}`;
      const stateRegions = regions[state.slug] || [];

      stateRegions.forEach(region => {
        paths.push({
          params: {
            category: category.slug,
            slug: stateSlug,
            region: region.slug
          }
        });
      });
    });
  });

  return paths;
}

// Get current page data from params
const { category, slug, region } = Astro.params;

// Parse the slug to get state info
const stateSlug = slug.replace(`${category}-in-`, '');
const currentCategory = categories.find(cat => cat.slug === category);
const currentState = states.find(state => state.slug === stateSlug);
const stateRegions = regions[stateSlug] || [];
const currentRegion = stateRegions.find(reg => reg.slug === region);

// Fallback if not found
if (!currentCategory || !currentState || !currentRegion) {
  return Astro.redirect('/404');
}

// Generate page title and meta
const pageTitle = `${currentCategory.name} in ${currentRegion.name}, ${currentState.name} | FLMint Deals`;
const description = `Find the best ${currentCategory.name.toLowerCase()} deals in ${currentRegion.name}, ${currentState.name}. Local dispensaries, products, and exclusive offers.`;

// Generate fallback local dispensaries for this region
const localDispensaries = [
  {
    name: `${currentRegion.name} Cannabis Co.`,
    address: `123 Main St, ${currentRegion.name}`,
    phone: '(555) 123-4567',
    rating: 4.8,
    specialties: [currentCategory.name, 'Pre-Rolls'],
    hours: 'Mon-Sat 9AM-9PM, Sun 10AM-8PM'
  },
  {
    name: `Green ${currentRegion.name}`,
    address: `456 Cannabis Blvd, ${currentRegion.name}`,
    phone: '(555) 234-5678',
    rating: 4.6,
    specialties: [currentCategory.name, 'Edibles'],
    hours: 'Daily 8AM-10PM'
  },
  {
    name: `${currentRegion.name} Wellness`,
    address: `789 Dispensary Ave, ${currentRegion.name}`,
    phone: '(555) 345-6789',
    rating: 4.7,
    specialties: ['Medical', currentCategory.name],
    hours: 'Mon-Fri 8AM-8PM, Weekends 9AM-9PM'
  }
];

// Generate sample deals for this region
const regionalDeals = [
  {
    title: `Premium ${currentCategory.name} - ${currentRegion.name} Exclusive`,
    dispensary: localDispensaries[0].name,
    originalPrice: 65,
    salePrice: 45,
    discount: 31,
    description: `Top-shelf ${currentCategory.name.toLowerCase()} available exclusively in ${currentRegion.name}`,
    expires: '2024-12-31'
  },
  {
    title: `${currentRegion.name} Special: Buy 2 Get 1 Free`,
    dispensary: localDispensaries[1].name,
    originalPrice: 120,
    salePrice: 80,
    discount: 33,
    description: `Limited time offer on all ${currentCategory.name.toLowerCase()} products`,
    expires: '2024-12-25'
  }
];

// Get related categories
const relatedCategories = categories.filter(cat => cat.slug !== category).slice(0, 3);
---

<Layout title={pageTitle} description={description}>
  <!-- Breadcrumb Navigation -->
  <nav class="bg-slate-50 dark:bg-slate-900 py-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center space-x-2 text-sm">
        <a href="/" class="text-emerald-600 hover:text-emerald-800">Home</a>
        <span class="text-slate-400">/</span>
        <a href={`/${category}`} class="text-emerald-600 hover:text-emerald-800">{currentCategory.name}</a>
        <span class="text-slate-400">/</span>
        <a href={`/${category}/${slug}`} class="text-emerald-600 hover:text-emerald-800">{currentState.name}</a>
        <span class="text-slate-400">/</span>
        <span class="text-slate-600">{currentRegion.name}</span>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section class="relative bg-gradient-to-r from-emerald-600 via-green-600 to-teal-600">
    <div class="absolute inset-0 bg-black opacity-20"></div>
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 text-center">
      <div class="flex items-center justify-center space-x-4 mb-6">
        <span class="text-6xl">{currentCategory.icon}</span>
        <span class="text-6xl">{currentState.emoji}</span>
        <span class="text-4xl">üìç</span>
      </div>
      <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tight">
        {currentCategory.name} in {currentRegion.name}
      </h1>
      <p class="text-xl md:text-2xl text-emerald-100 mb-4 max-w-3xl mx-auto leading-relaxed">
        Discover the best {currentCategory.name.toLowerCase()} deals and dispensaries in {currentRegion.name}, {currentState.name}
      </p>
      <div class="flex items-center justify-center space-x-6 text-emerald-200">
        <span class="flex items-center">
          <span class="mr-2">üìç</span>
          {currentRegion.type} ‚Ä¢ {currentRegion.population}
        </span>
      </div>
    </div>
  </section>

  <!-- Regional Info Banner -->
  <section class="py-8 bg-emerald-50 dark:bg-emerald-900/20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">
          About {currentRegion.name}
        </h2>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-emerald-600">{localDispensaries.length}+</div>
            <div class="text-sm text-gray-600 dark:text-gray-300">Licensed Dispensaries</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-emerald-600">{regionalDeals.length}</div>
            <div class="text-sm text-gray-600 dark:text-gray-300">Active Deals</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-emerald-600">{currentRegion.population}</div>
            <div class="text-sm text-gray-600 dark:text-gray-300">Population</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Current Deals Section -->
  <section class="py-16 bg-white dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          Current {currentCategory.name} Deals in {currentRegion.name}
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Exclusive offers from local dispensaries
        </p>
      </div>

      <div class="grid md:grid-cols-2 gap-8">
        {regionalDeals.map((deal) => (
          <div class="bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 rounded-2xl p-6 border border-emerald-200 dark:border-emerald-700">
            <div class="flex justify-between items-start mb-4">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                {deal.title}
              </h3>
              <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                -{deal.discount}%
              </span>
            </div>
            <p class="text-gray-600 dark:text-gray-300 mb-4">{deal.description}</p>
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <span class="text-2xl font-bold text-emerald-600">${deal.salePrice}</span>
                <span class="text-lg text-gray-500 line-through">${deal.originalPrice}</span>
              </div>
              <button class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                View Deal
              </button>
            </div>
            <div class="mt-4 pt-4 border-t border-emerald-200 dark:border-emerald-700">
              <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300">
                <span>{deal.dispensary}</span>
                <span>Expires: {deal.expires}</span>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Local Dispensaries Section -->
  <section class="py-16 bg-slate-50 dark:bg-slate-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          {currentCategory.name} Dispensaries in {currentRegion.name}
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Licensed dispensaries near you
        </p>
      </div>

      <div class="grid gap-6">
        {localDispensaries.map((dispensary) => (
          <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                  <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                    {dispensary.name}
                  </h3>
                  <div class="flex items-center space-x-1">
                    <span class="text-yellow-400">‚òÖ</span>
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">
                      {dispensary.rating}
                    </span>
                  </div>
                </div>
                <p class="text-gray-600 dark:text-gray-300 mb-2">{dispensary.address}</p>
                <p class="text-gray-600 dark:text-gray-300 mb-2">{dispensary.phone}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">{dispensary.hours}</p>
              </div>
              <div class="mt-4 md:mt-0 md:ml-6">
                <div class="flex flex-wrap gap-2 mb-4">
                  {dispensary.specialties.map((specialty) => (
                    <span class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-300 text-xs font-medium px-2 py-1 rounded-full">
                      {specialty}
                    </span>
                  ))}
                </div>
                <button class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200">
                  Visit Store
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Related Categories -->
  <section class="py-16 bg-white dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          Other Products in {currentRegion.name}
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Explore more cannabis products available in your area
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-8">
        {relatedCategories.map((cat) => (
          <a
            href={`/${cat.slug}/${cat.slug}-in-${stateSlug}/${region}`}
            class="group bg-gradient-to-br from-slate-50 to-gray-50 dark:from-slate-800 dark:to-gray-800 rounded-2xl p-8 text-center hover:shadow-lg hover:-translate-y-2 transition-all duration-300 border border-gray-200 dark:border-gray-700"
          >
            <div class="text-6xl mb-4 group-hover:scale-110 transition-transform duration-300">
              {cat.icon}
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
              {cat.name} in {currentRegion.name}
            </h3>
            <p class="text-gray-600 dark:text-gray-300">
              Explore {cat.name.toLowerCase()} products and deals
            </p>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Other Regions in State -->
  <section class="py-16 bg-emerald-50 dark:bg-emerald-900/20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          {currentCategory.name} in Other {currentState.name} Regions
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Find {currentCategory.name.toLowerCase()} in nearby areas
        </p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {stateRegions.filter(reg => reg.slug !== region).map((reg) => (
          <a
            href={`/${category}/${slug}/${reg.slug}`}
            class="bg-white dark:bg-slate-800 rounded-xl p-4 text-center hover:shadow-lg hover:-translate-y-1 transition-all duration-200 border border-gray-200 dark:border-gray-700"
          >
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-1">
              {reg.name}
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
              {reg.type} ‚Ä¢ {reg.population}
            </p>
            <span class="text-emerald-600 text-sm font-medium">
              View {currentCategory.name} ‚Üí
            </span>
          </a>
        ))}
      </div>
    </div>
  </section>
</Layout>