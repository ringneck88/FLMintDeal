---
import Layout from '../layouts/Layout.astro';
import { strapi } from '../lib/strapi';

const pageTitle = 'Cannabis Events | FLMint Deals';
const description = 'Discover cannabis events, educational workshops, and community gatherings in your area.';

// Fetch events from API with fallback
let events = [];
let announcements = [];

try {
  const eventsResponse = await strapi.getMany('/events', {
    populate: ['stores', 'region', 'brand', 'hero_media'],
    filters: { is_active: { $eq: true } },
    sort: ['start_at:asc'],
    pagination: { pageSize: 20 }
  });
  events = eventsResponse.data || [];

  const announcementsResponse = await strapi.getMany('/announcements', {
    populate: ['stores', 'regions'],
    filters: { is_active: { $eq: true } },
    sort: ['start_at:desc'],
    pagination: { pageSize: 10 }
  });
  announcements = announcementsResponse.data || [];
} catch (error) {
  console.log('Using fallback events and announcements data');

  // Sample events data
  events = [
    {
      id: 1,
      documentId: 'cannabis-education-101',
      title: 'Cannabis Education 101: Understanding Dosage',
      slug: 'cannabis-education-101',
      description: 'Join us for an informative session about cannabis dosing, effects, and safe consumption practices. Perfect for new patients and curious minds.',
      start_at: '2024-12-20T18:00:00.000Z',
      end_at: '2024-12-20T20:00:00.000Z',
      rsvp_url: 'https://flmint.com/events/cannabis-education-101',
      is_active: true,
      stores: [{ Name: 'FL Mint Miami Beach' }],
      region: { Name: 'South Florida' },
      location_override: null
    },
    {
      id: 2,
      documentId: 'holiday-appreciation-event',
      title: 'Holiday Customer Appreciation Event',
      slug: 'holiday-appreciation-event',
      description: 'Celebrate the holidays with special discounts, refreshments, and door prizes. Meet with product specialists and learn about our latest inventory.',
      start_at: '2024-12-22T15:00:00.000Z',
      end_at: '2024-12-22T19:00:00.000Z',
      rsvp_url: null,
      is_active: true,
      stores: [{ Name: 'FL Mint Orlando Downtown' }, { Name: 'FL Mint Tampa' }],
      region: { Name: 'Central Florida' },
      location_override: null
    },
    {
      id: 3,
      documentId: 'new-year-wellness-workshop',
      title: 'New Year Wellness Workshop: CBD & Holistic Health',
      slug: 'new-year-wellness-workshop',
      description: 'Start 2025 with a focus on wellness! Learn about CBD products, holistic health approaches, and how cannabis can support your wellness journey.',
      start_at: '2025-01-05T14:00:00.000Z',
      end_at: '2025-01-05T16:30:00.000Z',
      rsvp_url: 'https://flmint.com/events/wellness-workshop',
      is_active: true,
      stores: [{ Name: 'FL Mint Jacksonville' }],
      region: { Name: 'North Florida' },
      location_override: null
    },
    {
      id: 4,
      documentId: 'concentrate-masterclass',
      title: 'Concentrate Masterclass: Extracts & Dabbing',
      slug: 'concentrate-masterclass',
      description: 'Advanced session for experienced users. Learn about different extraction methods, dabbing techniques, and concentrate safety. 21+ only.',
      start_at: '2025-01-12T17:00:00.000Z',
      end_at: '2025-01-12T19:00:00.000Z',
      rsvp_url: 'https://flmint.com/events/concentrate-masterclass',
      is_active: true,
      stores: [{ Name: 'FL Mint Miami Beach' }, { Name: 'FL Mint Tampa' }],
      region: { Name: 'South Florida' },
      location_override: null
    },
    {
      id: 5,
      documentId: 'women-in-cannabis-meetup',
      title: 'Women in Cannabis: Industry Networking Meetup',
      slug: 'women-in-cannabis-meetup',
      description: 'Network with female professionals, entrepreneurs, and advocates in the cannabis industry. Light refreshments provided.',
      start_at: '2025-01-18T18:30:00.000Z',
      end_at: '2025-01-18T21:00:00.000Z',
      rsvp_url: 'https://flmint.com/events/women-in-cannabis',
      is_active: true,
      stores: [{ Name: 'FL Mint Orlando Downtown' }],
      region: { Name: 'Central Florida' },
      location_override: null
    }
  ];

  // Sample announcements data
  announcements = [
    {
      id: 1,
      documentId: 'holiday-hours-update',
      title: 'Holiday Hours Update',
      slug: 'holiday-hours-update',
      body: 'Please note our modified hours during the holiday season: Dec 24th - Closing at 6PM, Dec 25th - Closed, Dec 31st - Closing at 8PM, Jan 1st - Closed.',
      severity: 'info',
      start_at: '2024-12-15T00:00:00.000Z',
      end_at: '2025-01-02T23:59:59.000Z',
      is_active: true,
      stores: [{ Name: 'All Locations' }],
      regions: [{ Name: 'Statewide' }]
    },
    {
      id: 2,
      documentId: 'new-product-alert',
      title: 'New Product Alert: Premium Live Resin Collection',
      slug: 'new-product-alert',
      body: 'We\'re excited to announce the arrival of our Premium Live Resin Collection featuring strains from top Florida cultivators. Available in limited quantities.',
      severity: 'info',
      start_at: '2024-12-18T00:00:00.000Z',
      end_at: '2024-12-25T23:59:59.000Z',
      is_active: true,
      stores: [{ Name: 'FL Mint Miami Beach' }, { Name: 'FL Mint Orlando Downtown' }],
      regions: [{ Name: 'South Florida' }, { Name: 'Central Florida' }]
    },
    {
      id: 3,
      documentId: 'inventory-shortage-notice',
      title: 'Temporary Shortage: Popular Edible Brands',
      slug: 'inventory-shortage-notice',
      body: 'Due to high demand, several popular edible products are temporarily out of stock. We expect restocking by early January. Thank you for your patience.',
      severity: 'warning',
      start_at: '2024-12-19T00:00:00.000Z',
      end_at: '2025-01-15T23:59:59.000Z',
      is_active: true,
      stores: [{ Name: 'All Locations' }],
      regions: [{ Name: 'Statewide' }]
    }
  ];
}

// Helper function to format dates
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function formatTime(dateString) {
  const date = new Date(dateString);
  return date.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
}

// Helper function to get severity color classes
function getSeverityClasses(severity) {
  switch (severity) {
    case 'urgent':
      return 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700 text-red-800 dark:text-red-200';
    case 'warning':
      return 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200';
    default:
      return 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-700 text-blue-800 dark:text-blue-200';
  }
}
---

<Layout title={pageTitle} description={description}>
  <!-- Hero Section -->
  <section class="relative bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600">
    <div class="absolute inset-0 bg-black opacity-20"></div>
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 text-center">
      <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tight">
        Cannabis Events & News
      </h1>
      <p class="text-xl md:text-2xl text-purple-100 mb-8 max-w-3xl mx-auto leading-relaxed">
        Stay connected with our community through educational events, workshops, and important announcements.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="#events" class="inline-flex items-center px-6 py-3 bg-white text-purple-700 font-semibold rounded-lg shadow-lg hover:bg-purple-50 transition-colors duration-200">
          üìÖ View Events
        </a>
        <a href="#announcements" class="inline-flex items-center px-6 py-3 border-2 border-white text-white font-semibold rounded-lg hover:bg-white hover:text-purple-700 transition-colors duration-200">
          üì¢ Latest News
        </a>
      </div>
    </div>
  </section>

  <!-- Announcements Section -->
  <section id="announcements" class="py-16 bg-slate-50 dark:bg-slate-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          üì¢ Important Announcements
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Stay informed about store updates, product alerts, and important notices
        </p>
      </div>

      {announcements.length > 0 ? (
        <div class="space-y-6">
          {announcements.map((announcement) => (
            <div class={`border rounded-xl p-6 shadow-sm ${getSeverityClasses(announcement.severity)}`}>
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center space-x-3 mb-3">
                    <h3 class="text-xl font-bold">
                      {announcement.title}
                    </h3>
                    <span class={`inline-block px-2 py-1 text-xs font-medium rounded-full ${
                      announcement.severity === 'urgent' ? 'bg-red-100 text-red-800' :
                      announcement.severity === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-blue-100 text-blue-800'
                    }`}>
                      {announcement.severity.toUpperCase()}
                    </span>
                  </div>
                  <div class="prose prose-sm max-w-none mb-4">
                    <p>{announcement.body}</p>
                  </div>
                  <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center space-x-4">
                      <span>üìç {announcement.stores?.map(s => s.Name).join(', ') || 'All Locations'}</span>
                      {announcement.regions && announcement.regions.length > 0 && (
                        <span>üó∫Ô∏è {announcement.regions.map(r => r.Name).join(', ')}</span>
                      )}
                    </div>
                    <span>Valid until {formatDate(announcement.end_at)}</span>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md mx-auto">
            <div class="text-6xl mb-4">üì¢</div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Current Announcements</h3>
            <p class="text-gray-600 dark:text-gray-300">Check back soon for important updates and news!</p>
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- Events Section -->
  <section id="events" class="py-16 bg-white dark:bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">
          üìÖ Upcoming Events
        </h2>
        <p class="text-lg text-gray-600 dark:text-gray-300">
          Join us for educational workshops, community events, and special occasions
        </p>
      </div>

      {events.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {events.map((event) => (
            <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-2 border border-gray-200 dark:border-gray-700">
              <div class="bg-gradient-to-r from-purple-500 to-indigo-500 p-6">
                <div class="text-white">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">
                      {formatDate(event.start_at)}
                    </span>
                    <span class="text-sm font-medium opacity-90">
                      {formatTime(event.start_at)}
                    </span>
                  </div>
                  <h3 class="text-xl font-bold leading-tight">
                    {event.title}
                  </h3>
                </div>
              </div>

              <div class="p-6">
                <p class="text-gray-600 dark:text-gray-300 text-sm mb-4 line-clamp-3">
                  {event.description}
                </p>

                <div class="space-y-2 mb-6">
                  <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                    <span class="mr-2">üìç</span>
                    <span>{event.stores?.map(s => s.Name).join(', ') || 'Multiple Locations'}</span>
                  </div>
                  {event.region && (
                    <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                      <span class="mr-2">üó∫Ô∏è</span>
                      <span>{event.region.Name}</span>
                    </div>
                  )}
                  {event.end_at && (
                    <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                      <span class="mr-2">‚è∞</span>
                      <span>Until {formatTime(event.end_at)}</span>
                    </div>
                  )}
                </div>

                <div class="flex items-center justify-between">
                  {event.rsvp_url ? (
                    <a
                      href={event.rsvp_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors duration-200"
                    >
                      RSVP Required
                    </a>
                  ) : (
                    <span class="inline-flex items-center px-4 py-2 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 font-semibold rounded-lg">
                      Drop-in Welcome
                    </span>
                  )}
                  <span class="text-xs text-gray-400">
                    Free Event
                  </span>
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-8 max-w-md mx-auto">
            <div class="text-6xl mb-4">üìÖ</div>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No Upcoming Events</h3>
            <p class="text-gray-600 dark:text-gray-300">Check back soon for exciting cannabis education and community events!</p>
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
        Stay Connected
      </h2>
      <p class="text-lg text-gray-600 dark:text-gray-300 mb-8">
        Follow us on social media and sign up for our newsletter to never miss an event or important announcement.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/newsletter" class="inline-flex items-center px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors duration-200">
          üìß Subscribe to Newsletter
        </a>
        <a href="/contact" class="inline-flex items-center px-6 py-3 border-2 border-emerald-600 text-emerald-600 dark:text-emerald-400 font-semibold rounded-lg hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors duration-200">
          üí¨ Contact Us
        </a>
      </div>
    </div>
  </section>
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>