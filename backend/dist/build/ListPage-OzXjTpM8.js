import{u as b,eL as k,a as N,b as $,r as F,j as e,cw as f,cK as _,cL as q,l as v,M as H,a8 as Q,h as g,Z as G,a0 as D,o as z,eM as J,q as w,bF as Y,$ as K,a1 as Z,a2 as V,b3 as B,d as j,c as W,L as A,cN as L,bT as l,I as X,F as ee,cO as E}from"./strapi-Cxs8f-5s.js";import{a as se,g as P,u as te,b as ae}from"./getActionTypesDefaultMessages-B0SrFX_z.js";import{g as ie}from"./users-DLc-PG84.js";const U=()=>{const{formatDate:s}=b();return n=>{const a=k(n),o=s(a,{dateStyle:"long"}),t=s(a,{timeStyle:"medium",hourCycle:"h24"});return`${o}, ${t}`}},ne=({handleClose:s,logId:i})=>{const{toggleNotification:n}=N(),{_unstableFormatAPIError:a}=$(),{data:o,error:t,isLoading:d}=se(i);F.useEffect(()=>{t&&(n({type:"danger",message:a(t)}),s())},[t,a,s,n]);const c=U(),u=o&&"date"in o?c(o.date):"";return e.jsx(f.Root,{defaultOpen:!0,onOpenChange:s,children:e.jsxs(f.Content,{children:[e.jsx(f.Header,{children:e.jsx(_,{label:u,id:"title",children:e.jsx(q,{isCurrent:!0,children:u})})}),e.jsx(f.Body,{children:e.jsx(oe,{isLoading:d,data:o,formattedDate:u})})]})})},oe=({isLoading:s,data:i,formattedDate:n})=>{const{formatMessage:a}=b();if(s)return e.jsx(v,{padding:7,justifyContent:"center",alignItems:"center",children:e.jsx(H,{children:"Loading content..."})});const{action:o,user:t,payload:d}=i;return e.jsxs(e.Fragment,{children:[e.jsx(Q,{marginBottom:3,children:e.jsx(g,{variant:"delta",id:"title",children:a({id:"Settings.permissions.auditLogs.details",defaultMessage:"Log Details"})})}),e.jsxs(G.Root,{gap:4,gridCols:2,paddingTop:4,paddingBottom:4,paddingLeft:6,paddingRight:6,marginBottom:4,background:"neutral100",hasRadius:!0,children:[e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),actionName:a({id:`Settings.permissions.auditLogs.${o}`,defaultMessage:P(o)},{model:d?.model})}),e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"}),actionName:n}),e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),actionName:t?.displayName||"-"}),e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.userId",defaultMessage:"User ID"}),actionName:t?.id.toString()||"-"})]}),e.jsxs(D.Root,{children:[e.jsx(D.Label,{children:a({id:"Settings.permissions.auditLogs.payload",defaultMessage:"Payload"})}),e.jsx(re,{value:JSON.stringify(d,null,2),disabled:!0})]})]})},re=z(J)`
  max-width: 100%;
  overflow: scroll;
`,h=({actionLabel:s,actionName:i})=>e.jsxs(v,{direction:"column",alignItems:"baseline",gap:1,children:[e.jsx(g,{textColor:"neutral600",variant:"sigma",children:s}),e.jsx(g,{textColor:"neutral600",children:i})]}),de=({canReadAuditLogs:s,canReadUsers:i})=>{const{toggleNotification:n}=N(),{_unstableFormatAPIError:a}=$(),[{query:o}]=w(),{data:t,error:d,isError:c,isLoading:u}=Y({},{skip:!i,refetchOnMountOrArgChange:!0});F.useEffect(()=>{d&&n({type:"danger",message:a(d)})},[d,n,a]);const{data:y,isLoading:S,isError:C,error:p}=te(o,{refetchOnMountOrArgChange:!0,skip:!s});return F.useEffect(()=>{p&&n({type:"danger",message:a(p)})},[p,n,a]),{auditLogs:y,users:t?.users??[],isLoading:u||S,hasError:C||c}},O=s=>{const{formatMessage:i}=b(),n=K(s.name),a=i({id:"Settings.permissions.auditLogs.filter.aria-label",defaultMessage:"Search and select an option to filter"}),o=t=>{n.onChange(s.name,t)};return e.jsx(Z,{"aria-label":a,value:n.value,onChange:o,children:s.options?.map(t=>{const d=typeof t=="string"?t:t.value,c=typeof t=="string"?t:t.label;return e.jsx(V,{value:d,children:c},d)})})},le=({formatMessage:s,users:i,canReadUsers:n})=>{const a=[{label:s({id:"components.FilterOptions.FILTER_TYPES.$eq",defaultMessage:"is"}),value:"$eq"},{label:s({id:"components.FilterOptions.FILTER_TYPES.$ne",defaultMessage:"is not"}),value:"$ne"}],o=[{input:O,label:s({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),name:"action",operators:a,options:Object.keys(ae).map(t=>({label:s({id:`Settings.permissions.auditLogs.${t}`,defaultMessage:P(t)},{model:void 0}),value:t})),type:"enumeration"},{label:s({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"}),name:"date",type:"datetime"}];return n&&i?[...o,{input:O,label:s({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),mainField:{name:"id",type:"integer"},name:"user",operators:a,options:i.map(t=>({label:ie(t),value:t.id.toString()})),type:"relation"}]:o},ce=()=>{const{formatMessage:s}=b(),i=B(r=>r.admin_app.permissions.settings),{allowedActions:{canRead:n,canReadUsers:a},isLoading:o}=W({...i?.auditLogs,readUsers:i?.users.read||[]}),[{query:t},d]=w(),{auditLogs:c,users:u,isLoading:y,hasError:S}=de({canReadAuditLogs:n,canReadUsers:a}),C=U(),p=le({formatMessage:s,users:u,canReadUsers:a}),M=[{name:"action",label:s({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),sortable:!0},{name:"date",label:s({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"}),sortable:!0},{name:"user",label:s({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),sortable:!1,cellFormatter:({user:r})=>r?r.displayName:""}];if(S)return e.jsx(j.Error,{});const T=y||o,{results:I=[]}=c??{};return e.jsxs(j.Main,{"aria-busy":T,children:[e.jsx(j.Title,{children:s({id:"Settings.PageTitle",defaultMessage:"Settings - {name}"},{name:s({id:"global.auditLogs",defaultMessage:"Audit Logs"})})}),e.jsx(A.Header,{title:s({id:"global.auditLogs",defaultMessage:"Audit Logs"}),subtitle:s({id:"Settings.permissions.auditLogs.listview.header.subtitle",defaultMessage:"Logs of all the activities that happened in your environment"})}),e.jsx(A.Action,{startActions:e.jsxs(L.Root,{options:p,children:[e.jsx(L.Trigger,{}),e.jsx(L.Popover,{zIndex:499}),e.jsx(L.List,{})]})}),e.jsxs(A.Content,{children:[e.jsx(l.Root,{rows:I,headers:M,isLoading:T,children:e.jsxs(l.Content,{children:[e.jsx(l.Head,{children:M.map(r=>e.jsx(l.HeaderCell,{...r},r.name))}),e.jsx(l.Empty,{}),e.jsx(l.Loading,{}),e.jsx(l.Body,{children:I.map(r=>e.jsxs(l.Row,{onClick:()=>d({id:r.id}),children:[M.map(x=>{const{name:m,cellFormatter:R}=x;switch(m){case"action":return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:s({id:`Settings.permissions.auditLogs.${r.action}`,defaultMessage:P(r.action)},{model:r.payload?.model??""})})},m);case"date":return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:C(r.date)})},m);case"user":return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:R?R(r,x):"-"})},m);default:return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:r[m]||"-"})},m)}}),e.jsx(l.Cell,{onClick:x=>x.stopPropagation(),children:e.jsx(v,{justifyContent:"end",children:e.jsx(X,{onClick:()=>d({id:r.id}),withTooltip:!1,label:s({id:"app.component.table.view",defaultMessage:"{target} details"},{target:`${r.action} action`}),variant:"ghost",children:e.jsx(ee,{})})})})]},r.id))})]})}),e.jsxs(E.Root,{...c?.pagination,children:[e.jsx(E.PageSize,{}),e.jsx(E.Links,{})]})]}),t?.id&&e.jsx(ne,{handleClose:()=>d({id:""},"remove"),logId:t.id.toString()})]})},pe=()=>{const s=B(i=>i.admin_app.permissions.settings?.auditLogs?.main);return e.jsx(j.Protect,{permissions:s,children:e.jsx(ce,{})})};export{ce as ListPage,pe as ProtectedListPage};
