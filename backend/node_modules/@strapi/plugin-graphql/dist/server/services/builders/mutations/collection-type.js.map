{"version":3,"file":"collection-type.js","sources":["../../../../../server/src/services/builders/mutations/collection-type.ts"],"sourcesContent":["import { extendType, nonNull, idArg } from 'nexus';\nimport type * as Nexus from 'nexus';\nimport type { Struct } from '@strapi/types';\nimport type { Context } from '../../types';\n\nexport default ({ strapi }: Context) => {\n  const { service: getService } = strapi.plugin('graphql');\n\n  const { naming } = getService('utils');\n  const { args } = getService('internals');\n\n  const {\n    getCreateMutationTypeName,\n    getUpdateMutationTypeName,\n    getDeleteMutationTypeName,\n    getContentTypeInputName,\n    getTypeName,\n  } = naming;\n\n  const addCreateMutation = (\n    t: Nexus.blocks.ObjectDefinitionBlock<'Mutation'>,\n    contentType: Struct.CollectionTypeSchema\n  ) => {\n    const { uid } = contentType;\n\n    const createMutationName = getCreateMutationTypeName(contentType);\n    const typeName = getTypeName(contentType);\n\n    t.field(createMutationName, {\n      type: typeName,\n\n      extensions: {\n        strapi: {\n          contentType,\n        },\n      },\n\n      args: {\n        // Create payload\n        status: args.PublicationStatusArg,\n        data: nonNull(getContentTypeInputName(contentType)),\n      },\n\n      async resolve(parent, args, context) {\n        const { auth } = context.state;\n\n        // Sanitize input data\n        const sanitizedInputData = await strapi.contentAPI.sanitize.input(args.data, contentType, {\n          auth,\n        });\n\n        return strapi.documents!(uid).create({\n          ...args,\n          data: sanitizedInputData,\n        });\n      },\n    });\n  };\n\n  const addUpdateMutation = (\n    t: Nexus.blocks.ObjectDefinitionBlock<'Mutation'>,\n    contentType: Struct.CollectionTypeSchema\n  ) => {\n    const { uid } = contentType;\n\n    const updateMutationName = getUpdateMutationTypeName(contentType);\n    const typeName = getTypeName(contentType);\n\n    t.field(updateMutationName, {\n      type: typeName,\n\n      extensions: {\n        strapi: {\n          contentType,\n        },\n      },\n\n      args: {\n        documentId: nonNull(idArg()),\n        status: args.PublicationStatusArg,\n        data: nonNull(getContentTypeInputName(contentType)),\n      },\n\n      async resolve(parent, args, context) {\n        const { auth } = context.state;\n\n        const { data, ...restParams } = args;\n\n        // Sanitize input data\n        const sanitizedInputData = await strapi.contentAPI.sanitize.input(data, contentType, {\n          auth,\n        });\n\n        return strapi.documents!(uid).update({\n          ...restParams,\n          data: sanitizedInputData,\n        });\n      },\n    });\n  };\n\n  const addDeleteMutation = (\n    t: Nexus.blocks.ObjectDefinitionBlock<'Mutation'>,\n    contentType: Struct.CollectionTypeSchema\n  ) => {\n    const { uid } = contentType;\n\n    const deleteMutationName = getDeleteMutationTypeName(contentType);\n\n    const { DELETE_MUTATION_RESPONSE_TYPE_NAME } = strapi.plugin('graphql').service('constants');\n\n    t.field(deleteMutationName, {\n      type: DELETE_MUTATION_RESPONSE_TYPE_NAME,\n\n      extensions: {\n        strapi: {\n          contentType,\n        },\n      },\n\n      args: {\n        documentId: nonNull(idArg()),\n      },\n\n      async resolve(parent, args) {\n        const { documentId } = args;\n\n        await strapi.documents!(uid).delete({ documentId });\n\n        return { documentId };\n      },\n    });\n  };\n\n  return {\n    buildCollectionTypeMutations(contentType: Struct.CollectionTypeSchema) {\n      const createMutationName = `Mutation.${getCreateMutationTypeName(contentType)}`;\n      const updateMutationName = `Mutation.${getUpdateMutationTypeName(contentType)}`;\n      const deleteMutationName = `Mutation.${getDeleteMutationTypeName(contentType)}`;\n\n      const extension = getService('extension');\n\n      const registerAuthConfig = (action: string, auth: any) => {\n        return extension.use({ resolversConfig: { [action]: { auth } } });\n      };\n\n      const isActionEnabled = (action: string) => {\n        return extension.shadowCRUD(contentType.uid).isActionEnabled(action);\n      };\n\n      const isCreateEnabled = isActionEnabled('create');\n      const isUpdateEnabled = isActionEnabled('update');\n      const isDeleteEnabled = isActionEnabled('delete');\n\n      if (isCreateEnabled) {\n        registerAuthConfig(createMutationName, { scope: [`${contentType.uid}.create`] });\n      }\n\n      if (isUpdateEnabled) {\n        registerAuthConfig(updateMutationName, { scope: [`${contentType.uid}.update`] });\n      }\n\n      if (isDeleteEnabled) {\n        registerAuthConfig(deleteMutationName, { scope: [`${contentType.uid}.delete`] });\n      }\n\n      return extendType({\n        type: 'Mutation',\n\n        definition(t) {\n          if (isCreateEnabled) {\n            addCreateMutation(t, contentType);\n          }\n\n          if (isUpdateEnabled) {\n            addUpdateMutation(t, contentType);\n          }\n\n          if (isDeleteEnabled) {\n            addDeleteMutation(t, contentType);\n          }\n        },\n      });\n    },\n  };\n};\n"],"names":["strapi","service","getService","plugin","naming","args","getCreateMutationTypeName","getUpdateMutationTypeName","getDeleteMutationTypeName","getContentTypeInputName","getTypeName","addCreateMutation","t","contentType","uid","createMutationName","typeName","field","type","extensions","status","PublicationStatusArg","data","nonNull","resolve","parent","context","auth","state","sanitizedInputData","contentAPI","sanitize","input","documents","create","addUpdateMutation","updateMutationName","documentId","idArg","restParams","update","addDeleteMutation","deleteMutationName","DELETE_MUTATION_RESPONSE_TYPE_NAME","delete","buildCollectionTypeMutations","extension","registerAuthConfig","action","use","resolversConfig","isActionEnabled","shadowCRUD","isCreateEnabled","isUpdateEnabled","isDeleteEnabled","scope","extendType","definition"],"mappings":"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"}